.PHONY: all help install install-client install-go lint lint-client lint-go migrate codegen codegen-client codegen-go codegen-proto build build-client build-go clean test dev docker-dev docker-dev-down client-dev questionsgen docker-images docker-image-api docker-image-questionsgen

GOCMD = go
JSCMD = pnpm
DOCKER_COMPOSE = docker compose -f infra/docker/docker-compose.dev.yml
DOCKER_EXEC = docker exec quizory go run
GOTOOL = $(GOCMD) tool
BINARIES_DIR = out
CLIENT_DIR = client

all: help

help:
	@echo "install        : Installs the dependencies (Go & JS)."
	@echo "lint           : Runs linters (golangci-lint & eslint)."
	@echo "migrate        : Runs database migrations."
	@echo "codegen        : Runs codegen tools."
	@echo "build          : Builds the project."
	@echo "clean          : Removes the outputs generated by the build command."
	@echo "test           : Runs tests."
	@echo "dev            : Runs the local Docker infra, client, and API server in dev mode."
	@echo "questionsgen   : Runs the the questions generation once."
	@echo "docker-images  : Builds the backend Docker images."

install: install-go install-client

install-client:
	cd $(CLIENT_DIR) && $(JSCMD) install

install-go:
	$(GOCMD) install google.golang.org/protobuf/cmd/protoc-gen-go@v1.35.1 && \
	$(GOCMD) install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.5.1 && \
	$(GOCMD) mod tidy

lint: lint-go lint-client

lint-client:
	cd $(CLIENT_DIR) && $(JSCMD) lint

lint-go:
	golangci-lint run

migrate:
	$(DOCKER_EXEC) ./cmd/migrate

codegen: codegen-go codegen-client codegen-proto

codegen-client:
	cd $(CLIENT_DIR) && $(JSCMD) codegen

codegen-go:
	$(DOCKER_EXEC) ./cmd/codegen

codegen-proto:
	protoc --proto_path=http/grpc/proto \
		--go_out=paths=source_relative:http/grpc/proto \
		--go-grpc_out=paths=source_relative:http/grpc/proto \
		http/grpc/proto/*.proto

build: install build-go build-client

build-client:
	cd $(CLIENT_DIR) && $(JSCMD) build

build-go:
	$(GOCMD) build -o $(BINARIES_DIR)/api -v ./cmd/api

clean:
	rm -rf $(BINARIES_DIR) && rm -rf $(CLIENT_DIR)/dist && rm -rf $(CLIENT_DIR)/src/generated/api/apis

test:
	$(GOCMD) test -race -shuffle=on ./...

dev:
	@sh -c '\
		$(MAKE) docker-dev & DOCKER_PID=$$!; \
		$(MAKE) client-dev & CLIENT_PID=$$!; \
		wait $$DOCKER_PID $$CLIENT_PID'

docker-dev:
	$(DOCKER_COMPOSE) up $(ARGS)

docker-dev-down:
	$(DOCKER_COMPOSE) down

client-dev:
	cd $(CLIENT_DIR) && $(JSCMD) dev

questionsgen: docker-image-questionsgen
	docker run --rm \
		--network docker_quizory \
		--network docker_telemetry \
		--env-file .env.quizory \
		-e OTEL_SERVICE_NAME=quizory-questionsgen \
		sasalatart/quizory-questionsgen

docker-images: docker-image-api docker-image-questionsgen

docker-image-api:
	docker build -t sasalatart/quizory-api -f ./infra/docker/Dockerfile.api .

docker-image-questionsgen:
	docker build -t sasalatart/quizory-questionsgen -f ./infra/docker/Dockerfile.questionsgen .
